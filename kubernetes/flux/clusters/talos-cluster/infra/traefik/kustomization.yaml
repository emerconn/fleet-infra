# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert.yaml
- grafana-dashboard.yaml
- middleware.yaml
- tls-option.yaml
- ../../../../infra/components/ingress/traefik.yaml
patches:
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: traefik
      namespace: flux-system
    spec:
      values:
        deployment:
          kind: DaemonSet
        ingressClass:
          name: traefik
          enabled: true
          isDefaultClass: false
        ingressRoute:
          dashboard:
            enabled: true
            matchRule: Host(`traefik.homelab.emerconnelly.com`)
            entryPoints: ["websecure"]
            tls:
              secretName: ingress-tls
          healthcheck:
            enabled: true
            matchRule: Host(`traefik.homelab.emerconnelly.com`) && Path(`/ping`)
            entryPoints: ["websecure", "web"]
            tls:
              secretName: ingress-tls
        service:
          spec:
            loadBalancerIP: 172.21.0.170
        providers:
          kubernetesCRD:
            enabled: true
            allowCrossNamespace: true
        logs:
          access:
            enabled: true
            addInternals: true
        metrics:
          prometheus:
            service:
              enabled: true
            disableAPICheck: false
            serviceMonitor:
              enabled: true
              honorLabels: true
        tracing:
          addInternals: true
          otlp:
            enabled: true
            grpc:
              enabled: true
              endpoint: "openobserve-collector-agent-collector.openobserve-collector.svc.cluster.local:4317"
              insecure: true
        globalArguments: # manually set to remove anonymous usage data
        - "--global.checknewversion"
