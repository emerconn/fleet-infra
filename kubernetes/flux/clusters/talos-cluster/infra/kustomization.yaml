# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
# - vault-secrets-operator
- cilium.yaml
- ../../../infra/classes/ingress/ingress-nginx.yaml
- ../../../infra/classes/ingress/traefik.yaml
- ../../../infra/classes/storage/nfs-subdir-external-provisioner.yaml
- ../../../infra/components/system/snapshot-controller.yaml
- ../../../infra/components/cert-manager.yaml
- ../../../infra/components/external-secrets.yaml
- ../../../infra/components/reflector.yaml
- ../../../infra/components/vault-secrets-operator.yaml
patches:
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: nfs-subdir-external-provisioner
      namespace: flux-system
    spec:
      values:
        nfs:
          path: /volume1/talos-cluster
- target:
    kind: Secret
    name: hashicorpcloud-serviceprincipal-taloscluster
    namespace: vault-secrets-operator-system
  patch: |- # manually created auth for HCP project 'talos-cluster' https://developer.hashicorp.com/hcp/tutorials/get-started-hcp-vault-secrets/hcp-vault-secrets-kubernetes-vso
    - op: add
      path: /metadata/annotations
      value:
        reflector.v1.k8s.emberstack.com/reflection-allowed: "true"
        reflector.v1.k8s.emberstack.com/reflection-allowed-namespaces: ""
        reflector.v1.k8s.emberstack.com/reflection-auto-enabled: "true"
        reflector.v1.k8s.emberstack.com/reflection-auto-namespaces: "ass"
