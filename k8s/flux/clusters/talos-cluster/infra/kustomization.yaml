# yaml-language-server: $schema=https://json.schemastore.org/kustomization
apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
- cert-manager
- cilium
- cronjob-janitor
- database
- ingress
- kube-prometheus-stack
- minio-operator
- minio-tenant
- node-feature-discovery
- observe
- synology-csi-talos
- vault-secrets-operator
- ../../../infra/components/eraser.yaml
- ../../../infra/components/descheduler.yaml
- ../../../infra/components/observe/opentelemetry-operator.yaml
- ../../../infra/components/secrets/external-secrets.yaml
- ../../../infra/components/secrets/reflector.yaml
- ../../../infra/components/storage/nfs-subdir-external-provisioner.yaml
- ../../../infra/components/system/snapshot-controller.yaml
patches:
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: descheduler
      namespace: flux-system
    spec:
      values:
        kind: Deployment
        service:
          enabled: true
        serviceMonitor: # TODO: create Grafana dashboard
          enabled: true
          namespace: descheduler
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: eraser
      namespace: flux-system
    spec:
      values:
        runtimeConfig:
          components:
            scanner:
              enabled: false
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: nfs-subdir-external-provisioner
      namespace: flux-system
    spec:
      values:
        nfs:
          path: /volume1/talos-cluster
- patch: |-
    apiVersion: helm.toolkit.fluxcd.io/v2
    kind: HelmRelease
    metadata:
      name: snapshot-controller
      namespace: flux-system
    spec:
      values:
        controller:
          serviceMonitor: # TODO: create Grafana dashboard
            create: true
